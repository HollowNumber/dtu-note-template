name: Create Package Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (leave empty to read from typst.toml)"
        required: false

permissions:
  contents: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Create and Package Template

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Extract version and create package structure
        run: |
          echo "ðŸ“‹ Extracting version from typst.toml..."

          # Extract version from typst.toml
          VERSION=$(grep 'version.*=' typst.toml | cut -d'"' -f2)
          echo "Package version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Use manual version if provided
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          fi

          echo "ðŸ“¦ Creating package structure for version $VERSION..."

          # Create the package directory structure
          mkdir -p "dtu-template/$VERSION"

          # Copy src directory contents to versioned directory
          cp -r src/* "dtu-template/$VERSION/"

          # Create root typst.toml with correct version
          cp typst.toml dtu-template/

          # Update version in the root typst.toml if manual version provided
          if [ -n "${{ github.event.inputs.version }}" ]; then
            sed -i "s/version = \".*\"/version = \"$VERSION\"/" dtu-template/typst.toml
          fi

          echo "ðŸ“„ Package structure created:"
          find dtu-template -type f | sort

      - name: Validate package before publishing
        run: |
          echo "ðŸ” Final validation before publishing..."

          VERSION=${{ env.VERSION }}

          # Verify all files and directories are present
          required_files=(
            "dtu-template/typst.toml"
            "dtu-template/$VERSION/lib.typ"
            "dtu-template/$VERSION/assets/dtu-logo-cmyk.png"
            "dtu-template/$VERSION/colors.typ"
            "dtu-template/$VERSION/layouts.typ"
            "dtu-template/$VERSION/enhanced.typ"
          )

          required_dirs=(
            "dtu-template/$VERSION/components"
            "dtu-template/$VERSION/styles" 
            "dtu-template/$VERSION/helpers"
            "dtu-template/$VERSION/layouts"
            "dtu-template/$VERSION/assets"
          )

          echo "ðŸ” Final validation before publishing..."

          # Verify essential files are present
          required_files=(
            "dtu-template/typst.toml"
            "dtu-template/$VERSION/lib.typ"
            "dtu-template/$VERSION/assets/dtu-logo-cmyk.png"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Error: Required file $file is missing"
              exit 1
            fi
          done

          # Verify src folder was copied completely
          if [ ! -d "dtu-template/$VERSION" ]; then
            echo "âŒ Error: Version directory is missing"
            exit 1
          fi

          # Count files to ensure structure was copied
          file_count=$(find "dtu-template/$VERSION" -type f | wc -l)
          if [ "$file_count" -lt 10 ]; then
            echo "âŒ Error: Too few files copied ($file_count found, expected at least 10)"
            exit 1
          fi

          echo "âœ… Package validation passed! ($file_count files found)"

          echo "ðŸ“‹ Package contents:"
          echo "Root typst.toml:"
          cat dtu-template/typst.toml
          echo ""
          echo "ðŸ“ All files copied from src/:"
          find "dtu-template/$VERSION/" -type f | sort
          echo ""
          echo "âœ… Complete folder structure copied successfully!"

          # Test compilation one more time
          mkdir -p final-test
          cat > final-test/test.typ << EOF
          #import "../dtu-template/$VERSION/lib.typ": dtu-note

          #show: dtu-note.with(
            course: "02101",
            title: "Final Test",
            author: "CI Test"
          )

          = Test
          This is a final compilation test before publishing.
          EOF

          cd final-test
          typst compile --root .. test.typ test.pdf

          if [ $? -eq 0 ]; then
            echo "âœ… Final compilation test passed"
          else
            echo "âŒ Final compilation test failed"
            exit 1
          fi

      - name: Create release archive
        run: |
          VERSION=${{ env.VERSION }}
          echo "ðŸ“¦ Creating release archive..."

          # Create tarball for release
          tar -czf "dtu-template-$VERSION.tar.gz" dtu-template/

          echo "âœ… Archive created: dtu-template-$VERSION.tar.gz"

          # Display archive contents
          echo "ðŸ“„ Archive contents:"
          tar -tzf "dtu-template-$VERSION.tar.gz" | head -20

      - name: Upload release asset
        if: github.event_name == 'release'
        run: |
          echo "ðŸš€ Uploading release asset..."
          gh release upload ${{ github.ref_name }} "dtu-template-${{ env.VERSION }}.tar.gz" --clobber
          echo "âœ… Release asset uploaded successfully!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: dtu-template-package
          path: |
            dtu-template/
            dtu-template-${{ env.VERSION }}.tar.gz
          retention-days: 30

      - name: Create package summary
        run: |
          VERSION=${{ env.VERSION }}
          echo "ï¿½ Package created successfully!"
          echo ""
          echo "ðŸ“‹ Release Details:"
          echo "Repository: ${{ github.repository }}"
          echo "Version: $VERSION"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "Tag: ${{ github.ref_name }}"
          fi
          echo ""
          echo "ðŸ“¦ Package Structure:"
          echo "âœ“ dtu-template/typst.toml (root package config)"
          echo "âœ“ dtu-template/$VERSION/ (versioned package files)"
          echo "âœ“ dtu-template/$VERSION/lib.typ (main library)"
          echo "âœ“ dtu-template/$VERSION/components/ (academic & visual components)"
          echo "âœ“ dtu-template/$VERSION/styles/ (spacing & typography utilities)"
          echo "âœ“ dtu-template/$VERSION/helpers/ (layout & content helpers)"
          echo "âœ“ dtu-template/$VERSION/layouts/ (note & assignment templates)"
          echo "âœ“ dtu-template/$VERSION/assets/ (static resources)"
          echo "âœ“ dtu-template/$VERSION/VERSION.typ (version metadata)"
          echo ""
          echo "ðŸ—ï¸ Modular Architecture:"
          echo "  â€¢ Enhanced component organization"
          echo "  â€¢ Better maintainability and extensibility"
          echo "  â€¢ Backward compatibility maintained"
          echo ""
          echo "âœ… Package ready for distribution!"
